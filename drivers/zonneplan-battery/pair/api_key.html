<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Onbalansmarkt API Key</title>
</head>
<body>
  <homey-pair>
    <h1 data-i18n="pair.zonneplan.api_key.title">Onbalansmarkt Integratie</h1>
    <p data-i18n="pair.zonneplan.api_key.subtitle">Optioneel: voer je Onbalansmarkt API key in om automatisch data te versturen</p>

    <form class="homey-form">
      <div class="homey-form-group">
        <label class="homey-form-label" for="apiKey" data-i18n="pair.zonneplan.api_key.api_key">API Key</label>
        <input id="apiKey" type="text" class="homey-form-input" placeholder="your-api-key-here" />
        <small class="homey-form-hint" data-i18n="pair.zonneplan.api_key.api_key.hint">Verkrijg een API key op https://onbalansmarkt.com (optioneel)</small>
      </div>

      <div class="homey-form-group">
        <label class="homey-form-label">
          <input id="autoSend" type="checkbox" />
          <span data-i18n="pair.zonneplan.api_key.auto_send">Automatisch metingen versturen</span>
        </label>
        <small class="homey-form-hint" data-i18n="pair.zonneplan.api_key.auto_send.hint">Stuur batterijdata automatisch naar Onbalansmarkt wanneer deze via flow card ontvangen wordt</small>
      </div>

      <div class="homey-form-buttons">
        <button type="button" id="skipBtn" class="button" data-i18n="pair.buttons.skip">Overslaan</button>
        <button type="submit" class="button positive" data-i18n="pair.buttons.finish">Voltooien</button>
      </div>
    </form>
  </homey-pair>

  <script>
    Homey.setTitle(Homey.__('pair.zonneplan.api_key.title'));

    const form = document.querySelector('form');
    const apiKeyInput = document.getElementById('apiKey');
    const autoSendCheckbox = document.getElementById('autoSend');
    const skipBtn = document.getElementById('skipBtn');
    const submitButton = form.querySelector('button[type="submit"]');

    // Skip button - proceed without API key
    skipBtn.addEventListener('click', async () => {
      try {
        await Homey.emit('store_api_key', {
          apiKey: '',
          autoSend: false,
        });
        Homey.nextView();
      } catch (error) {
        Homey.showDialog('error', {
          title: 'Error',
          body: error.message || 'Failed to continue.',
        });
      }
    });

    // Submit form with API key
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const apiKey = apiKeyInput.value.trim();
      const autoSend = autoSendCheckbox.checked;

      // API key is optional, but if auto-send is enabled, require API key
      if (autoSend && !apiKey) {
        Homey.showDialog('error', {
          title: Homey.__('error.validation.title'),
          body: Homey.__('pair.zonneplan.api_key.error.api_key_required') || 'API key is required when auto-send is enabled.',
        });
        return;
      }

      submitButton.disabled = true;

      try {
        await Homey.emit('store_api_key', {
          apiKey,
          autoSend,
        });
        Homey.nextView();
      } catch (error) {
        Homey.showDialog('error', {
          title: 'Error',
          body: error.message || 'Failed to store API key.',
        });
        submitButton.disabled = false;
      }
    });

    apiKeyInput.focus();
  </script>
</body>
</html>
